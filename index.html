<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Count (This Month)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #2b5876, #4e4376);
    color: #fff;
    text-align: center;
    padding: 30px;
  }
  h1 { margin-bottom: 10px; }
  p { margin-bottom: 20px; }

  table {
    width: 90%;
    max-width: 700px;
    margin: 15px auto;
    border-collapse: collapse;
    background: #fff;
    color: #000;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  th, td {
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }
  th {
    background: #4e4376;
    color: #fff;
  }

  .summary-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
  }

  .half {
    flex: 1 1 300px;
    max-width: 400px;
  }
</style>
</head>
<body>

<h1>Teacher Attendance (This Month)</h1>
<p id="rangeInfo">Loading...</p>

<h2>Records This Month</h2>
<table id="dataTable">
  <thead><tr><th>Date</th><th>Teacher</th></tr></thead>
  <tbody></tbody>
</table>

<h2>Summary (Count per Teacher)</h2>
<div class="summary-container">
  <table class="half" id="summaryLeft">
    <thead><tr><th>Teacher</th><th>Count</th></tr></thead>
    <tbody></tbody>
  </table>

  <table class="half" id="summaryRight">
    <thead><tr><th>Teacher</th><th>Count</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRgjGiwz_YAGf5XkE77TTP5BydKRO_Dp1I95wRFkUGS4M36kX1hpQWotXy5NHi7yg5HkWDpUDufZK2p/pub?output=csv";

async function loadCSV() {
  const rangeInfo = document.getElementById("rangeInfo");
  const tbody = document.querySelector("#dataTable tbody");
  const leftBody = document.querySelector("#summaryLeft tbody");
  const rightBody = document.querySelector("#summaryRight tbody");
  tbody.innerHTML = leftBody.innerHTML = rightBody.innerHTML = "";

  try {
    const response = await fetch(csvUrl);
    const text = await response.text();
    const rows = text.trim().split(/\r?\n/).map(r => r.split(","));

    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const today = now.getDate();
    rangeInfo.textContent = `Showing records from 1/${month}/${year} to ${today}/${month}/${year}`;

    const teacherCounts = {};

    for (let i = 1; i < rows.length; i++) {
      const dateStr = rows[i][0]?.trim();
      const teacher = rows[i][1]?.trim();
      if (!dateStr || !teacher) continue;

      // parse MM/DD/YYYY HH:MM:SS
      const [datePart] = dateStr.split(" ");
      const [mm, dd, yyyy] = datePart.split("/").map(Number);
      const dateObj = new Date(yyyy, mm - 1, dd);

      if (dateObj.getMonth() + 1 === month && dateObj.getFullYear() === year) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${dateStr}</td><td>${teacher}</td>`;
        tbody.appendChild(tr);
        teacherCounts[teacher] = (teacherCounts[teacher] || 0) + 1;
      }
    }

    const entries = Object.entries(teacherCounts).sort((a,b) => b[1] - a[1]);
    if (entries.length === 0) {
      tbody.innerHTML = `<tr><td colspan="2">No data for this month.</td></tr>`;
      leftBody.innerHTML = rightBody.innerHTML = `<tr><td colspan="2">No data</td></tr>`;
      return;
    }

    // Split into two halves
    const mid = Math.ceil(entries.length / 2);
    const left = entries.slice(0, mid);
    const right = entries.slice(mid);

    for (const [name, count] of left) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
      leftBody.appendChild(tr);
    }
    for (const [name, count] of right) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td>${count}</td>`;
      rightBody.appendChild(tr);
    }

  } catch (err) {
    rangeInfo.textContent = "⚠️ Failed to fetch the sheet.";
    console.error(err);
  }
}

loadCSV();
</script>
</body>
</html>
